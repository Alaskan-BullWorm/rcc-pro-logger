<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>RCC Pro Logger</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link rel="preconnect" href="https://unpkg.com" crossorigin>
<style>
  :root{
    --bg:#0b0f1a; --panel:#0d1426; --ink:#e7ecf5; --muted:#9fb1d1;
    --line:#1a2540; --accent:#22c55e; --warn:#f59e0b; --err:#ef4444; --focus:#3b82f6;
    --chip:#0a1229; --ink-strong:#ffffff; --ok:#16a34a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family: ui-sans-serif, system-ui, -apple-system, "SF Pro", Segoe UI, Roboto, Arial;
    background: radial-gradient(1200px 600px at 10% -10%, #121a34 0%, #0b0f1a 40%, #070a14 100%);
    padding-bottom: env(safe-area-inset-bottom);
  }
  header{
    padding:14px 16px; position:sticky; top:0; z-index:10;
    backdrop-filter:saturate(140%) blur(6px);
    background:#080d1acc; border-bottom:1px solid var(--line);
  }
  .header-wrap{max-width:1100px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:12px}
  .brand{display:flex; align-items:center; gap:10px}
  .logo{width:36px; height:36px; border-radius:10px; overflow:hidden; display:grid; place-items:center; background:linear-gradient(135deg,#2dd4bf 0%,#22c55e 35%,#4ade80 70%,#60a5fa 100%); box-shadow:0 5px 28px #22c55e22}
  .logo svg{width:22px; height:22px; color:#05140a}
  h1{margin:0; font-size:16px; letter-spacing:.3px}
  .pill{background:var(--chip); border:1px solid var(--line); padding:6px 10px; border-radius:999px; font-size:12px; color:#cbd5e1}
  .btn{cursor:pointer; padding:12px 12px; border-radius:12px; border:1px solid #243255; background:#0f172a; color:var(--ink); font-weight:700; letter-spacing:.2px; transition:transform .05s ease}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:linear-gradient(180deg,#22c55e,#16a34a); color:#03140b; border-color:#0b3b22}
  .btn.secondary{background:#0c1224}
  .btn.warning{background:linear-gradient(180deg,#f59e0b,#d97706); color:#1a1203; border-color:#6b3f03}
  main{max-width:1100px; margin:18px auto 90px; padding:0 14px}
  .grid{display:grid; gap:18px; grid-template-columns:1.3fr .7fr}
  .card{background:linear-gradient(180deg,#0c1328 0%, #0a1022 100%); border:1px solid var(--line); border-radius:16px; padding:16px; box-shadow:0 18px 60px #0007}
  .section-title{margin:0 0 12px; font-size:16px; font-weight:800; color:var(--ink-strong)}
  .row{display:grid; gap:12px; grid-template-columns:repeat(2,minmax(0,1fr)); margin-bottom:10px}
  label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
  .input-wrap{position:relative}
  input, textarea, select{
    width:100%; padding:14px 12px; border-radius:12px; border:1px solid #223055; outline:none;
    background:#0b132a; color:#e7ecf5; font-size:16px; transition:border .15s ease, box-shadow .15s ease;
  }
  textarea{min-height:180px; resize:vertical}
  input:focus, textarea:focus, select:focus{border-color:var(--focus); box-shadow:0 0 0 3px #3b82f633}
  input::placeholder, textarea::placeholder{color:#7383a6}
  .unit{position:absolute; right:10px; top:50%; transform:translateY(-50%); color:#a9b4cf; font-size:12px; background:#09122a; border:1px solid #1d2a4b; padding:2px 6px; border-radius:8px; pointer-events:none}
  .inline{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .muted{color:#9fb1d1; font-size:12px}
  .kbd{font-family:ui-monospace,Menlo,monospace; background:#0c1328; border:1px solid #1d2a4b; padding:2px 6px; border-radius:6px; font-size:12px; color:#cbd5e1}
  .divider{height:1px; background:linear-gradient(90deg,transparent,#1b2746,transparent); margin:12px 0}
  .banner{border:1px solid #1e2b50; background:#0b152f; color:#bcd3ff; padding:10px 12px; border-radius:12px; font-size:13px}
  .banner.ok{border-color:#0a3e25; background:#082317; color:#b9f2ce}
  .banner.err{border-color:#4a1b1b; background:#220b0b; color:#fbcaca}
  table{width:100%; border-collapse:collapse; font-size:14px}
  th, td{border-bottom:1px dashed #223055; padding:10px 8px; text-align:left}
  th{color:#cbd5e1; font-weight:800; position:sticky; top:0; background:#0a0f20}
  tbody tr:hover{background:#0b1123}
  .hidden{display:none !important}
  .miss{color:#f59e0b; font-style:italic}
  .misscell{background:#2c1706}
  .badge{font-size:11px; padding:4px 8px; border:1px solid #253055; border-radius:8px; color:#9fb0d4; background:#09122a}
  video{width:100%; border:1px solid #1f294a; border-radius:10px; background:#000}
  canvas{max-width:100%; background:#050816; border:1px dashed #233057; border-radius:8px}
  .modal{position:fixed; inset:0; background:#0009; display:flex; align-items:flex-end; justify-content:center; z-index:50}
  .sheet{width:min(980px, 96vw); max-height:90vh; overflow:auto; background:#0a0f20; border:1px solid #1c2540; border-radius:16px 16px 0 0; padding:14px}
  .scan-grid{display:grid; grid-template-columns:1.2fr .8fr; gap:12px}
  .menu{position:relative}
  .menu-pop{position:absolute; right:0; top:110%; background:#0c1224; border:1px solid #223055; border-radius:10px; padding:6px; display:grid; gap:4px; z-index:20}
  .menu-pop button{background:#0d1426; color:#e7ecf5; border:1px solid #223055; padding:10px 12px; text-align:left; border-radius:8px; min-width:180px}
  #actionBar{position:fixed; left:0; right:0; bottom:0; z-index:40; display:flex; gap:8px; padding:10px 12px calc(12px + env(safe-area-inset-bottom)); backdrop-filter:saturate(140%) blur(8px); background:#060b18d9; border-top:1px solid #1a2746}
  .bar-btn{flex:1; min-height:52px; font-weight:800; border-radius:12px; border:1px solid #243255; background:#0f172a; color:#e7ecf5}
  .bar-btn.primary{background:linear-gradient(180deg,#22c55e,#16a34a); color:#07130b; border-color:#0b3b22}
  @media (min-width:860px){ #actionBar{position:sticky; bottom:auto; padding:0; background:transparent; border:0} main{margin-bottom:60px} }
  #sessionProgress{margin:10px 0}
  #progTrack{height:8px; border-radius:999px; background:#111a34; margin-top:8px; overflow:hidden}
  #progFill{height:100%; width:0%; background:linear-gradient(90deg,#22c55e,#60a5fa); transition:width .35s ease}
  #resumeBadge{cursor:pointer}
  .diff-ins{color:#b9f2ce}
  .diff-move{color:#fcd98d}
  @media (max-width: 980px){ .grid{grid-template-columns:1fr} .scan-grid{grid-template-columns:1fr} }
  @media (max-width: 600px){ input{padding:16px 14px; font-size:17px} .unit{right:12px} }
</style>
</head>
<body>
<header>
  <div class="header-wrap">
    <div class="brand">
      <div class="logo" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none"><path d="M6 18V6h7.2a4.8 4.8 0 0 1 0 9.6H10l4 2.4" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>
      <h1>RCC Pro Logger</h1>
    </div>
    <div class="inline">
      <span class="pill">Local Save: <strong id="lsStatus">ready</strong></span>
      <button class="btn secondary" id="btnReset" aria-label="Reset App">Reset</button>
    </div>
  </div>
</header>

<main>
  <!-- SETUP -->
  <section id="setupCard" class="card">
    <div class="section-title">1) Job Setup</div>
    <div class="banner" id="httpsHint">For camera & GPS on iPhone, open over <span class="kbd">https://</span> or from Files.</div>
    <div class="divider"></div>

    <div class="row">
      <div><label for="jobName">Job Name</label><input id="jobName" type="text" placeholder="e.g., I‑71 Ramp Improvements — Section B" required autocomplete="on"></div>
      <div><label for="jobDate">Job Date</label><input id="jobDate" type="date" required></div>
    </div>

    <div class="row">
      <div class="input-wrap"><label for="targetDensity">Target Density</label><input id="targetDensity" type="number" step="0.1" inputmode="decimal" placeholder="e.g., 135.0"><span class="unit">pcf</span></div>
      <div class="input-wrap"><label for="targetMoist">Target Moisture</label><input id="targetMoist" type="number" step="0.1" inputmode="decimal" placeholder="e.g., 7.0"><span class="unit">%</span></div>
    </div>

    <div class="row">
      <div style="grid-column:1 / -1">
        <label for="jobLocation">Job Location (address, city, state)</label>
        <div class="inline" style="gap:8px">
          <div class="input-wrap" style="flex:1"><input id="jobLocation" type="text" placeholder="e.g., 123 Main St, Columbus, OH" autocomplete="street-address"></div>
          <button class="btn secondary" id="btnUseGPS" style="white-space:nowrap">Use Current Location</button>
        </div>
        <div class="help" id="gpsStatus" aria-live="polite"></div>
      </div>
    </div>

    <div class="inline" style="gap:10px; margin-top:8px">
      <button class="btn primary" id="btnStart">Start Logging</button>
      <button class="btn secondary" id="btnLoad">Load Last Session</button>
    </div>

    <div class="inline pill" style="margin-top:10px; gap:12px; flex-wrap:wrap">
      <div>Origin: <span class="kbd">Geotechnical Consultants Inc., Westerville, Ohio</span></div>
      <div>Mileage Method: <span id="method" class="kbd">Routing (OSRM)</span></div>
      <div>Status: <span id="netStatus" class="kbd">idle</span></div>
    </div>
  </section>

  <!-- SESSION PROGRESS -->
  <section id="sessionProgress" class="banner">
    <div class="inline" style="justify-content:space-between; width:100%">
      <div><strong id="testsCount">0</strong> tests logged today</div>
      <div id="resumeBadge" class="pill hidden">Unfinished session — Resume?</div>
    </div>
    <div id="progTrack"><div id="progFill"></div></div>
  </section>

  <div class="grid">
    <!-- ENTRY -->
    <section id="entryCard" class="card hidden">
      <div class="section-title">2) RCC Results Entry</div>

      <div class="row">
        <div><label>Test # (auto)</label><input id="testNumber" type="text" disabled value="1"></div>
        <div><label for="testLocation">Test Location</label><input id="testLocation" type="text" placeholder="e.g., Sta. 10+50, LT 12’"></div>
      </div>

      <div class="row">
        <div class="input-wrap"><label for="wetDensity">Wet Density</label><input id="wetDensity" type="number" step="0.1" inputmode="decimal" placeholder="e.g., 149.0"><span class="unit">pcf</span></div>
        <div class="input-wrap"><label for="moisture">Moisture</label><input id="moisture" type="number" step="0.1" inputmode="decimal" placeholder="e.g., 8.9"><span class="unit">%</span></div>
      </div>

      <!-- NEW: Grid coordinate for this test -->
      <div class="row">
        <div class="input-wrap">
          <label for="gridCoord">Grid Coord (optional)</label>
          <input id="gridCoord" type="text" inputmode="latin" placeholder="e.g., A3" maxlength="4">
          <div class="help">Row letter(s) + column number (e.g., A3, B12). Must fit your site photo grid.</div>
        </div>
        <div class="inline" style="align-items:flex-end; gap:8px">
          <button class="btn secondary" id="btnScan">Scan Gauge (OCR)</button>
          <button class="btn secondary" id="btnImportNotes">Import Notes Screenshot</button>
          <button class="btn secondary" id="btnPasteText">Paste Text</button>
          <button class="btn secondary" id="btnPhotoGrid">Site Photo + Grid</button>
        </div>
      </div>

      <div class="input-wrap"><label for="densityPct">% of Target (auto)</label><input id="densityPct" type="text" disabled placeholder="—"><span class="unit">%</span></div>
      <div class="help">WD & Moisture accept whole numbers or one decimal. Grid Coord validated against your configured grid.</div>

      <div class="inline" style="gap:10px; margin-top:10px">
        <button class="btn primary" id="btnSaveNext">Save & Next Test</button>
        <button class="btn secondary" id="btnClearForm">Clear</button>
        <button class="btn warning" id="btnFinish">Finish & View Summary</button>
      </div>
    </section>

    <!-- SUMMARY -->
    <section id="summaryCard" class="card hidden">
      <div class="section-title">3) Summary</div>

      <div id="statusBanner" class="banner hidden"></div>

      <div class="inline" style="justify-content:space-between; gap:14px; margin:10px 0 6px">
        <div class="inline" style="gap:10px; flex-wrap:wrap">
          <span class="badge">Job: <strong id="summaryJobName">—</strong></span>
          <span class="badge">Target: <strong id="summaryTarget">—</strong></span>
          <span class="badge">Date: <strong id="summaryJobDate">—</strong></span>
          <span class="badge">Location: <strong id="summaryJobLocation">—</strong></span>
          <span class="badge">Mileage: <strong id="summaryMileage">— mi</strong></span>
        </div>
        <div class="menu">
          <button class="btn secondary" id="btnExport">Export ▾</button>
          <div id="exportMenu" class="menu-pop hidden">
            <button data-act="png">PNG</button>
            <button data-act="pdf">PDF</button>
            <button data-act="csv">CSV</button>
            <button data-act="svd">SVD</button>
            <button data-act="photo">Export Annotated Photo</button>
            <button data-act="share">Copy Share Link</button>
          </div>
        </div>
      </div>

      <!-- EXPORT AREA includes the photo -->
      <div id="exportArea" class="card" style="background:#091126; border-color:#16244a; padding:0">
        <div style="padding:16px 16px 0; border-bottom:1px solid #16244a">
          <h2 style="margin:0 0 6px; font-size:18px">RCC Test Log</h2>
          <div class="muted" id="summarySubtitle"></div>
        </div>

        <!-- Annotated photo (grid + markers) -->
        <div id="photoWrap" class="card hidden" style="background:#0b1227; border-color:#15254c; padding:12px; margin:12px">
          <div class="inline" style="justify-content:space-between; align-items:center">
            <div class="section-title" style="margin:0">Site Photo (Grid + Markers)</div>
            <span class="muted">Pins = test # at grid cell center</span>
          </div>
          <canvas id="photoCanvas" style="width:100%; max-height:60vh"></canvas>
        </div>

        <div style="overflow:auto; max-height:420px">
          <table id="testsTable">
            <thead><tr>
              <th style="width:60px">#</th><th>Test Location</th><th>Wet Density (pcf)</th>
              <th>Moisture (%)</th><th>% of Target</th><th style="width:90px">Grid</th><th style="width:110px">Mileage (mi)</th>
            </tr></thead>
            <tbody id="testsTbody"></tbody>
          </table>
        </div>
        <div style="padding:10px 16px; display:flex; justify-content:space-between; align-items:center">
          <div class="muted">Generated by RCC Pro Logger</div>
          <div class="muted" id="generatedAt"></div>
        </div>
      </div>

      <div class="inline" style="margin-top:10px">
        <button class="btn secondary" id="btnBackToEntry">Back to Entry</button>
      </div>
    </section>
  </div>
</main>

<!-- Bottom Action Bar -->
<nav id="actionBar" aria-label="primary actions">
  <button class="bar-btn primary" id="barSaveNext">Save & Next</button>
  <button class="bar-btn" id="barScan">Scan</button>
  <button class="bar-btn" id="barImport">Import Notes</button>
  <button class="bar-btn" id="barPaste">Paste Text</button>
  <button class="bar-btn" id="barPhoto">Site Photo + Grid</button>
</nav>

<!-- libs -->
<script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js" crossorigin="anonymous"></script>
<script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js" crossorigin="anonymous"></script>
<script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js" crossorigin="anonymous"></script>

<script>
/* ========================= Utilities & State ========================= */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const todayISO = () => new Date().toISOString().slice(0,10);
const miles = meters => +(meters / 1609.344).toFixed(2);
const clamp1 = v => Math.round(v*10)/10;
const toNumber = v => { const n = Number(String(v).trim()); return Number.isFinite(n) ? n : null; };

const LS_KEY = 'rcc_pro_logger_v6';
const ORIGIN_TEXT = 'Geotechnical Consultants Inc., Westerville, Ohio';
const NOMINATIM = 'https://nominatim.openstreetmap.org/search?format=json&limit=1&q=';
const NOMI_REV  = (lat,lon) => `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`;
const OSRM = 'https://router.project-osrm.org/route/v1/driving/';
const geocache = JSON.parse(localStorage.getItem('rcc_geo_cache') || '{}');

const state = {
  job: { name:'', date: todayISO(), location:'', targetDensity:null, targetMoist:null, mileageMi:null, origin: ORIGIN_TEXT, coords:null },
  tests: [], // {n, loc, wet, moist, pct, grid}
  photo: { original:null, annotatedBase:null, width:null, height:null, rows:10, cols:10, line:'#22c55e', alpha:0.8, lw:2, labels:true, markers:[] }
};

/* ========================= DOM & events ========================= */
const setupCard = $('#setupCard'), entryCard = $('#entryCard'), summaryCard = $('#summaryCard');
const jobName = $('#jobName'), jobDate = $('#jobDate'), jobLocation = $('#jobLocation'), targetDensity = $('#targetDensity'), targetMoist = $('#targetMoist');
const gpsStatus = $('#gpsStatus');
const testNumber = $('#testNumber'), testLocation = $('#testLocation'), wetDensity = $('#wetDensity'), moisture = $('#moisture'), densityPct = $('#densityPct');
const summaryJobName = $('#summaryJobName'), summaryTarget = $('#summaryTarget'), summaryJobDate = $('#summaryJobDate'), summaryJobLocation = $('#summaryJobLocation'), summaryMileage = $('#summaryMileage'), summarySubtitle = $('#summarySubtitle'), testsTbody = $('#testsTbody'), generatedAt = $('#generatedAt');
const statusBanner = $('#statusBanner');
const lsStatus = $('#lsStatus'), netStatus = $('#netStatus'), methodEl = $('#method');
const exportMenu = $('#exportMenu');

$('#btnStart').addEventListener('click', startLogging);
$('#btnLoad').addEventListener('click', loadLast);
$('#btnReset').addEventListener('click', resetAll);
$('#btnUseGPS').addEventListener('click', useCurrentLocation);

$('#btnSaveNext').addEventListener('click', onSaveNext);
$('#btnClearForm').addEventListener('click', () => clearEntry(false));
$('#btnFinish').addEventListener('click', showSummary);
$('#btnBackToEntry').addEventListener('click', () => { summaryCard.classList.add('hidden'); entryCard.classList.remove('hidden'); testLocation.focus(); });

$('#btnExport').addEventListener('click', ()=> exportMenu.classList.toggle('hidden'));
exportMenu.addEventListener('click', e=>{
  const act = e.target && e.target.dataset ? e.target.dataset.act : undefined;
  if(!act) return;
  exportMenu.classList.add('hidden');
  if (act==='png') exportPNG();
  if (act==='pdf') exportPDF();
  if (act==='csv') exportCSV();
  if (act==='svd') exportSVD();
  if (act==='photo') exportAnnotatedPhotoPNG();
  if (act==='share') copyShareLink();
});
document.addEventListener('click', (e)=>{ if(!exportMenu.contains(e.target) && e.target!==$('#btnExport')) exportMenu.classList.add('hidden'); });

$('#btnScan').addEventListener('click', openScanner);
$('#btnImportNotes').addEventListener('click', openImportNotes);
$('#btnPasteText').addEventListener('click', openPasteImport);
$('#btnPhotoGrid').addEventListener('click', openPhotoGrid);

// Bottom bar wiring
$('#barSaveNext').addEventListener('click', ()=> $('#btnSaveNext').click());
$('#barScan').addEventListener('click', ()=> $('#btnScan').click());
$('#barImport').addEventListener('click', ()=> $('#btnImportNotes').click());
$('#barPaste').addEventListener('click', ()=> $('#btnPasteText').click());
$('#barPhoto').addEventListener('click', ()=> $('#btnPhotoGrid').click());

[wetDensity, targetDensity].forEach(i => i.addEventListener('input', updatePctField));
document.addEventListener('keydown', e => {
  if (!entryCard.classList.contains('hidden') && e.key === 'Enter') { e.preventDefault(); onSaveNext(); }
});

jobDate.value = todayISO();
if (location.protocol === 'https:') $('#httpsHint').classList.add('hidden');
restoreFromURL();
updateProgress();

/* ========================= Core ========================= */
function startLogging(){
  const name = jobName.value.trim();
  const date = jobDate.value || todayISO();
  const loc  = jobLocation.value.trim();
  const tD   = toNumber(targetDensity.value);
  const tM   = toNumber(targetMoist.value);

  if (!name) return fieldError(jobName, 'Please enter a Job Name.');
  if (!loc)  return fieldError(jobLocation, 'Please enter a Job Location.');

  Object.assign(state.job, { name, date, location:loc, targetDensity:tD, targetMoist:tM });
  disableSetup();

  entryCard.classList.remove('hidden');
  testNumber.value = String(state.tests.length + 1);
  testLocation.focus();
  save(); updateProgress();

  computeMileage()
    .then(mi => { state.job.mileageMi = mi; summaryMileage.textContent = `${mi} mi`; save(); toast(`Mileage computed: ${mi} mi ✔️`, 'ok'); })
    .catch(() => { methodEl.textContent = 'Fallback (straight-line)'; toast('Routing failed, using straight‑line distance.', 'warn'); });
}
function disableSetup(){ [jobName, jobDate, jobLocation, targetDensity, targetMoist].forEach(i => i.disabled = true); $('#btnStart').disabled = true; $('#btnUseGPS').disabled = true; }
function fieldError(input, msg){ input.focus(); toast(msg, 'warn'); input.scrollIntoView({behavior:'smooth', block:'center'}); }

async function computeMileage(){
  netStatus.textContent = 'geocoding…';
  const [o, d] = await Promise.all([ geocodeCached(ORIGIN_TEXT), state.job.coords ? Promise.resolve(state.job.coords) : geocodeCached(state.job.location) ]);
  if (!o || !d) throw new Error('Geocoding failed');
  netStatus.textContent = 'routing…';
  const url = `${OSRM}${o.lon},${o.lat};${d.lon},${d.lat}?overview=false&alternatives=false&steps=false`;
  const res = await fetch(url, { headers:{'User-Agent':'RCC-Pro-Logger'} });
  if (res.ok){ const j = await res.json(); const m = j && j.routes && j.routes[0] ? j.routes[0].distance : undefined; if (typeof m === 'number'){ methodEl.textContent='Routing (OSRM)'; netStatus.textContent='ready'; return miles(m); } }
  methodEl.textContent='Fallback (straight-line)'; netStatus.textContent='ready';
  const mi = haversine(o.lat,o.lon,d.lat,d.lon); return +mi.toFixed(2);
}
async function geocodeCached(q){ if (geocache[q]) return geocache[q]; const hit = await geocode(q); if (hit){ geocache[q]=hit; localStorage.setItem('rcc_geo_cache', JSON.stringify(geocache)); } return hit; }
async function geocode(q){ const res = await fetch(NOMINATIM + encodeURIComponent(q), { headers:{'Accept-Language':'en'} }); if (!res.ok) return null; const a = await res.json(); if (!a || !a.length) return null; const g = a[0]; return {lat:+g.lat, lon:+g.lon, label:g.display_name}; }
async function reverseGeocode(lat,lon){ const res = await fetch(NOMI_REV(lat,lon), { headers:{'Accept-Language':'en'} }); if (!res.ok) return null; const d = await res.json(); return {lat:+lat, lon:+lon, label: d && d.display_name ? d.display_name : (lat.toFixed(6)+', '+lon.toFixed(6)) }; }
function haversine(lat1, lon1, lat2, lon2){ const toRad=d=>d*Math.PI/180, R=3958.761; const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1); const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2; return 2*R*Math.asin(Math.sqrt(a)); }

/* ========================= Entry & %Target ========================= */
function updatePctField(){ const wet=toNumber(wetDensity.value), t=toNumber(targetDensity.value); const pct=(wet!=null && t && t>0)? clamp1(wet/t*100): null; densityPct.value = pct==null ? '' : pct; }

function onSaveNext(){
  const loc = testLocation.value.trim();
  const wet = toNumber(wetDensity.value);
  const moi = toNumber(moisture.value);

  if (!loc) return toast('Enter a Test Location.', 'warn');
  if (wet === null) return toast('Enter Wet Density (pcf) as a number.', 'warn');
  if (moi === null) return toast('Enter Moisture (%) as a number.', 'warn');

  if (wet < 100 || wet > 170) toast('Wet Density seems off for RCC (~120–145 pcf).', 'warn');
  if (moi < 1 || moi > 20) toast('Moisture seems off (~4–10%).', 'warn');

  // NEW: grid coordinate
  const coordRaw = ($('#gridCoord')?.value || '').trim();
  let grid = null, marker = null;
  if (coordRaw){
    const rc = coordToRowCol(coordRaw);
    if (!rc) return toast('Grid Coord must look like A3 or B12.', 'warn');
    const p = state.photo;
    if (!p || !p.rows || !p.cols || !p.annotatedBase) return toast('You set a coordinate but no site photo grid is saved. Add a Site Photo + Grid first.', 'warn');
    if (!isCoordInBounds(rc.row, rc.col, p.rows, p.cols)) return toast(`Grid Coord ${coordRaw.toUpperCase()} out of bounds (A..${rowNumberToLetters(p.rows)} by 1..${p.cols}).`, 'warn');
    const xy = gridCellCenterPx(rc.row, rc.col, p);
    if (!xy) return toast('Could not map coordinate on photo.', 'err');
    grid = coordRaw.toUpperCase();
    marker = { coord:grid, x:xy.x, y:xy.y };
  }

  const t = state.job.targetDensity; const pct = (t && t>0) ? clamp1(wet/t*100) : null;
  const n = state.tests.length + 1; state.tests.push({ n, loc, wet, moist:moi, pct, grid });

  if (marker && state.photo){ marker.n = n; state.photo.markers.push(marker); }

  save(); updateProgress(); clearEntry(true); testNumber.value = String(state.tests.length + 1); testLocation.focus();
}
function clearEntry(keep){ if(!keep) testNumber.value = String(state.tests.length + 1); testLocation.value=''; wetDensity.value=''; moisture.value=''; densityPct.value=''; $('#gridCoord').value=''; }

/* ========================= Summary ========================= */
function showSummary(){
  summaryCard.classList.remove('hidden'); entryCard.classList.add('hidden');
  banner('ok', `Ready — ${state.tests.length} test${state.tests.length===1?'':'s'} logged.`);
  summaryJobName.textContent = state.job.name || '—';
  summaryTarget.textContent  = (state.job.targetDensity ? `${state.job.targetDensity} pcf` : '—') + (state.job.targetMoist!=null ? ` @ ${state.job.targetMoist}%` : '');
  summaryJobDate.textContent = state.job.date || '—';
  summaryJobLocation.textContent = state.job.location || '—';
  summaryMileage.textContent = (state.job.mileageMi ?? '—') + (state.job.mileageMi ? ' mi':'');
  const subtitle = []; if (state.tests.length) subtitle.push(`${state.tests.length} tests`); if (state.job.origin) subtitle.push(`Origin: ${state.job.origin}`);
  summarySubtitle.textContent = subtitle.join(' • ');
  generatedAt.textContent = 'Generated ' + new Date().toLocaleString();

  testsTbody.innerHTML = '';
  const mi = state.job.mileageMi ?? '—';
  for (const t of state.tests){
    const tdLoc = t.loc ? escapeHTML(t.loc) : `<span class="miss">missing</span>`;
    const tdWet = (t.wet!=null) ? t.wet : `<span class="miss">missing</span>`;
    const tdMoi = (t.moist!=null) ? t.moist : `<span class="miss">missing</span>`;
    const tdPct = (t.pct!=null) ? (Number.isFinite(t.pct) ? t.pct.toFixed(1) : t.pct) + '%' : `<span class="miss">—</span>`;
    const tdGrid = t.grid ? escapeHTML(t.grid) : '—';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${t.n}</td><td class="${t.loc?'':'misscell'}">${tdLoc}</td><td class="${t.wet!=null?'':'misscell'}">${tdWet}</td><td class="${t.moist!=null?'':'misscell'}">${tdMoi}</td><td class="${t.pct!=null?'':'misscell'}">${tdPct}</td><td>${tdGrid}</td><td>${mi}</td>`;
    testsTbody.appendChild(tr);
  }

  renderPhotoWithMarkersToCanvas();
}
function banner(kind, msg){
  statusBanner.classList.remove('hidden','ok','err');
  statusBanner.classList.add(kind==='ok'?'ok':'err', 'banner');
  statusBanner.textContent = msg;
}
function escapeHTML(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }

/* ========================= Save/Share ========================= */
function save(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); lsStatus.textContent='saved'; } catch{ lsStatus.textContent='error'; } }
function loadLast(){
  try{
    const raw = localStorage.getItem(LS_KEY); if (!raw) return toast('No saved session found.', 'warn');
    const data = JSON.parse(raw); if (!data || !data.job) return;
    Object.assign(state, data);
    jobName.value = state.job.name; jobDate.value = state.job.date; jobLocation.value = state.job.location;
    targetDensity.value = state.job.targetDensity ?? ''; targetMoist.value = state.job.targetMoist ?? '';
    disableSetup(); entryCard.classList.remove('hidden'); testNumber.value = String(state.tests.length + 1); testLocation.focus();
    renderPhotoWithMarkersToCanvas();
    updateProgress();
    toast('Session loaded ✔️','ok');
  }catch{ toast('Failed to load session.', 'err'); }
}
function resetAll(){ if (!confirm('Clear all data and restart?')) return; localStorage.removeItem(LS_KEY); location.href = location.pathname; }
async function copyShareLink(){
  const payload = btoa(unescape(encodeURIComponent(JSON.stringify(state))));
  const url = `${location.origin}${location.pathname}#${payload}`;
  try{ await navigator.clipboard.writeText(url); toast('Share link copied ✔️','ok'); } catch{ toast('Could not copy link','err'); }
}
function restoreFromURL(){
  const hash = location.hash.slice(1); if (!hash) return;
  try{
    const data = JSON.parse(decodeURIComponent(escape(atob(hash))));
    if (data && data.job && data.tests){
      Object.assign(state, data);
      jobName.value = state.job.name; jobDate.value = state.job.date; jobLocation.value = state.job.location;
      targetDensity.value = state.job.targetDensity ?? ''; targetMoist.value = state.job.targetMoist ?? '';
      disableSetup(); entryCard.classList.remove('hidden'); testNumber.value = String(state.tests.length + 1);
      showSummary(); updateProgress(); toast('Loaded from shared link ✔️','ok');
    }
  }catch{}
}

/* ========================= Export handlers ========================= */
async function ensureSummaryRendered(){ if (summaryCard.classList.contains('hidden')) showSummary(); await new Promise(r=>setTimeout(r,50)); }
async function exportPNG(){ await ensureSummaryRendered(); const c = await html2canvas($('#exportArea'), { backgroundColor:'#091126', scale:2 }); download(c.toDataURL('image/png'), `${slug(state.job.name)}-${state.job.date}-RCC.png`); }
async function exportPDF(){
  await ensureSummaryRendered();
  const c = await html2canvas($('#exportArea'), { backgroundColor:'#091126', scale:2 });
  const img = c.toDataURL('image/png'); const { jsPDF } = window.jspdf; const pdf = new jsPDF({ unit:'pt', format:'a4' });
  const pageW = pdf.internal.pageSize.getWidth(); const imgW = pageW - 48; const ratio = imgW / c.width; const imgH = c.height * ratio;
  pdf.addImage(img, 'PNG', 24, 24, imgW, imgH); pdf.save(`${slug(state.job.name)}-${state.job.date}-RCC.pdf`);
}
function exportCSV(){
  if (!state.tests.length) return toast('No tests to export.', 'warn');
  const mi = state.job.mileageMi ?? '';
  const rows = [
    ['Job Name', state.job.name], ['Job Date', state.job.date], ['Job Location', state.job.location],
    ['Target Density (pcf)', state.job.targetDensity ?? ''], ['Target Moisture (%)', state.job.targetMoist ?? ''], ['Mileage (mi)', mi], [],
    ['#','Test Location','Wet Density (pcf)','Moisture (%)','% of Target','Grid Coord','Mileage (mi)']
  ];
  for (const t of state.tests){ rows.push([t.n, t.loc ?? '', t.wet ?? '', t.moist ?? '', t.pct!=null ? t.pct : '', t.grid ?? '', mi]); }
  const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\r\n');
  download('data:text/csv;charset=utf-8,' + encodeURIComponent(csv), `${slug(state.job.name)}-${state.job.date}-RCC.csv`);
}
function exportSVD(){
  if (!state.tests.length) return toast('No tests to export.', 'warn');
  const mi = state.job.mileageMi ?? '';
  const header = [
    '# SVD 1.2',
    `JobName|${state.job.name}`, `JobDate|${state.job.date}`, `JobLocation|${state.job.location}`,
    `TargetDensity_pcf|${state.job.targetDensity ?? ''}`, `TargetMoist_pct|${state.job.targetMoist ?? ''}`,
    `Mileage_mi|${mi}`,
    '# Columns: Test#,TestLocation,WetDensity_pcf,Moisture_pct,PercentOfTarget,GridCoord,Mileage_mi'
  ].join('\n');
  const lines = state.tests.map(t => [t.n, t.loc ?? '', t.wet ?? '', t.moist ?? '', t.pct!=null ? t.pct : '', t.grid ?? '', mi].map(x=>String(x).replace(/\|/g,'/')).join('|'));
  download('data:text/plain;charset=utf-8,' + encodeURIComponent(header+'\n'+lines.join('\n')+'\n'), `${slug(state.job.name)}-${state.job.date}-RCC.svd`);
}
async function exportAnnotatedPhotoPNG(){
  const p = state.photo; if (!p || !p.annotatedBase) return toast('No annotated photo to export yet.', 'warn');
  // Ensure current markers are drawn to a fresh canvas, then export
  const tmp = document.createElement('canvas'); tmp.width = p.width; tmp.height = p.height;
  const ctx = tmp.getContext('2d');
  const base = await loadImage(p.annotatedBase);
  ctx.drawImage(base, 0, 0);
  drawMarkersOnCtx(ctx, p);
  download(tmp.toDataURL('image/png'), `${slug(state.job.name)}-${state.job.date}-RCC-photo.png`);
}
function slug(s=''){ return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
function download(href, filename){ const a=document.createElement('a'); a.href=href; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); }

/* ========================= GPS ========================= */
async function useCurrentLocation(){
  if (!('geolocation' in navigator)){ gpsStatus.textContent='Geolocation not supported.'; return toast('Geolocation unavailable','err'); }
  gpsStatus.textContent='Requesting location…'; $('#btnUseGPS').disabled = true;
  try{
    const pos = await new Promise((resolve,reject)=> navigator.geolocation.getCurrentPosition(resolve,reject,{ enableHighAccuracy:true, timeout:15000, maximumAge:0 }));
    const { latitude:lat, longitude:lon } = pos.coords;
    gpsStatus.textContent = `GPS: ${lat.toFixed(5)}, ${lon.toFixed(5)} — reverse geocoding…`;
    const rev = await reverseGeocode(lat,lon);
    if (rev){ jobLocation.value = rev.label; state.job.coords = {lat:rev.lat, lon:rev.lon, label:rev.label}; gpsStatus.textContent='Location set from GPS ✔️'; toast('Job location filled from current GPS','ok'); save(); }
    else { gpsStatus.textContent='Could not find address for GPS.'; toast('Reverse geocoding failed','warn'); }
  }catch{ gpsStatus.textContent='Location permission denied or timed out.'; toast('Location permission needed for GPS','warn'); }
  finally{ $('#btnUseGPS').disabled = false; }
}

/* ========================= OCR: Gauge Scanner ========================= */
let scanModal=null, scanStream=null;
function openScanner(){
  if (!scanModal) buildScannerModal();
  $('#scanStatus').textContent = 'Initializing camera…';
  scanModal.classList.remove('hidden');
  startCamera();
}
function buildScannerModal(){
  scanModal = document.createElement('div');
  scanModal.className='modal hidden';
  scanModal.innerHTML = `
    <div class="sheet">
      <header class="inline" style="justify-content:space-between">
        <h2>Scan Gauge (OCR)</h2>
        <div class="inline">
          <input type="file" id="fileInput" accept="image/*" class="btn secondary" style="padding:8px 10px; width:auto">
          <button class="btn secondary" id="btnCloseScan" style="width:auto">Close</button>
        </div>
      </header>
      <div class="scan-grid">
        <div><video id="video" playsinline autoplay muted></video></div>
        <div>
          <canvas id="frameCanvas" height="360"></canvas>
          <div id="scanStatus" class="help">—</div>
          <div class="inline" style="gap:8px">
            <button class="btn primary" id="btnCapture">Capture & Read</button>
            <button class="btn secondary" id="btnFill" disabled>Fill Fields</button>
          </div>
          <div class="help">Accepts integers or 1‑decimal (e.g., 149 / 149.0).</div>
          <pre id="ocrOut" class="muted" style="margin-top:8px; white-space:pre-wrap"></pre>
        </div>
      </div>
    </div>`;
  document.body.appendChild(scanModal);
  $('#btnCloseScan').addEventListener('click', closeScanner);
  $('#btnCapture').addEventListener('click', onCaptureAndRead);
  $('#btnFill').addEventListener('click', fillFromOCR);
  $('#fileInput').addEventListener('change', onPickImage);
}
function closeScanner(){ scanModal.classList.add('hidden'); stopCamera(); }
async function startCamera(){
  try{
    scanStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal:'environment' } }, audio:false });
    $('#video').srcObject = scanStream; await $('#video').play();
    $('#scanStatus').textContent = 'Camera ready. Capture when text is sharp.';
  }catch(e){ console.error(e); $('#scanStatus').textContent = 'Camera blocked/unavailable. Upload a photo instead.'; }
}
function stopCamera(){ if (scanStream){ for (const t of scanStream.getTracks()) t.stop(); } const v=$('#video'); if (v) v.srcObject=null; }

async function onCaptureAndRead(){
  const v = $('#video');
  if (!v.videoWidth) return $('#scanStatus').textContent = 'Camera not ready.';
  const W = 1000, H = Math.round(v.videoHeight * (W / v.videoWidth));
  const c = $('#frameCanvas'); c.width=W; c.height=H;
  const ctx = c.getContext('2d'); ctx.drawImage(v, 0, 0, W, H);
  preprocess(ctx, W, H);
  $('#scanStatus').textContent = 'Reading…';
  const { text, wd, moist } = await ocrGauge(c);
  showOcrResult(text, wd, moist);
}
async function onPickImage(ev){
  const file = ev.target.files && ev.target.files[0] ? ev.target.files[0] : null; if (!file) return;
  const img = new Image();
  img.onload = async ()=>{
    const maxW = 1600, scale = Math.min(1, maxW / img.width);
    const c = $('#frameCanvas'); c.width = Math.round(img.width*scale); c.height = Math.round(img.height*scale);
    const ctx = c.getContext('2d'); ctx.drawImage(img, 0, 0, c.width, c.height);
    preprocess(ctx, c.width, c.height);
    $('#scanStatus').textContent = 'Reading image…';
    const { text, wd, moist } = await ocrGauge(c);
    showOcrResult(text, wd, moist);
  };
  img.onerror = ()=> $('#scanStatus').textContent = 'Could not load image.';
  img.src = URL.createObjectURL(file);
}
function showOcrResult(text, wd, moist){
  $('#ocrOut').textContent = text.trim() || '(no text recognized)';
  if (wd!=null || moist!=null){
    $('#scanStatus').textContent = `Found: WD=${wd ?? '—'} pcf, %Moist=${moist ?? '—'} %`;
    scanModal.dataset.lastWd = wd ?? '';
    scanModal.dataset.lastMoist = moist ?? '';
    $('#btnFill').disabled = false;
    banner('ok', 'Gauge scan successful.');
  } else {
    $('#scanStatus').textContent = 'Couldn’t find WD/%Moist. Try closer, sharper image, or upload a photo.';
    $('#btnFill').disabled = true;
    banner('err', 'Gauge scan did not detect values.');
  }
}
function preprocess(ctx,w,h){
  const img = ctx.getImageData(0,0,w,h), d=img.data;
  const contrast=1.25, bright=10;
  for(let i=0;i<d.length;i+=4){ const r=d[i],g=d[i+1],b=d[i+2]; let y=(r*0.299+g*0.587+b*0.114); y=(y-128)*contrast+128+bright; y=y<0?0:y>255?255:y; d[i]=d[i+1]=d[i+2]=y; }
  ctx.putImageData(img,0,0);
}
async function ocrGauge(canvas){
  const out = { text:'', wd:null, moist:null };
  try{
    const res = await Tesseract.recognize(canvas, 'eng', { logger: m=>{} });
    const text = (res && res.data && res.data.text ? res.data.text : '').replace(/\r/g,'');
    out.text = text;
    const wdMatch = text.match(/\b(1\d{2}|[2-9]\d{2})(?:\.\d)?\b/);
    const moistMatch = text.match(/\b(\d{1,2})(?:\.\d)?\b/);
    out.wd = wdMatch ? parseFloat(wdMatch[0]) : null;
    out.moist = moistMatch ? parseFloat(moistMatch[0]) : null;
    if (out.wd!=null && (out.wd<100 || out.wd>200)) out.wd=null;
    if (out.moist!=null && (out.moist<0 || out.moist>40)) out.moist=null;
  }catch(e){ console.error(e); }
  return out;
}
function fillFromOCR(){
  const wd = scanModal.dataset.lastWd, m = scanModal.dataset.lastMoist;
  if (wd) wetDensity.value = wd;
  if (m)  moisture.value = m;
  updatePctField();
  toast(`Filled ${wd? 'WD':''}${wd&&m?', ':''}${m? '%Moist':''} from OCR ✔️`, 'ok');
  closeScanner();
}

/* ========================= NOTES IMPORT (image) + PASTE TEXT ========================= */
let importModal=null, parsedBlocks=[];
let diffModal=null, lastPlan=null;

function openImportNotes(){ if(!importModal) buildImportModal(); importModal.classList.remove('hidden'); }
function buildImportModal(){
  importModal = document.createElement('div'); importModal.className='modal hidden';
  importModal.innerHTML = `
    <div class="sheet">
      <header class="inline" style="justify-content:space-between">
        <h2>Import Notes Screenshot</h2>
        <div class="inline">
          <input type="file" id="notesFile" accept="image/*" class="btn secondary" style="padding:8px 10px; width:auto">
          <button class="btn secondary" id="btnCloseImport" style="width:auto">Close</button>
        </div>
      </header>
      <div class="row" style="grid-template-columns:1fr">
        <div class="help">Tests start with a number (e.g., <span class="kbd">1.</span>, <span class="kbd">2)</span>, <span class="kbd">3:</span>). First WD (100–250) and first Moist (0–40) after that (any order). Rest of the line(s) is location.</div>
        <canvas id="notesCanvas" height="360" class="hidden"></canvas>
        <pre id="notesOut" class="muted" style="white-space:pre-wrap"></pre>
        <div class="inline" style="gap:8px">
          <button class="btn primary" id="btnReview" disabled>Review Changes…</button>
        </div>
      </div>
    </div>`;
  document.body.appendChild(importModal);
  $('#btnCloseImport').addEventListener('click', ()=>importModal.classList.add('hidden'));
  $('#notesFile').addEventListener('change', onNotesPick);
  $('#btnReview').addEventListener('click', openDiffPreview);
}
async function onNotesPick(ev){
  const file = ev.target.files && ev.target.files[0] ? ev.target.files[0] : null; if (!file) return;
  const img = new Image();
  img.onload = async ()=>{
    const maxW = 1900, scale = Math.min(1, maxW / img.width);
    const c = $('#notesCanvas'); c.width = Math.round(img.width*scale); c.height = Math.round(img.height*scale);
    const ctx = c.getContext('2d'); ctx.drawImage(img, 0, 0, c.width, c.height);
    preprocess(ctx, c.width, c.height);
    let text=''; try{ const res = await Tesseract.recognize(c, 'eng', { logger: m=>{} }); text = (res && res.data && res.data.text ? res.data.text : '').replace(/\r/g,''); } catch(e){ console.error(e); }
    parsedBlocks = parseNotesBlocks(text);
    const preview = parsedBlocks.length
      ? parsedBlocks.map(o => `#${o.n} | WD:${o.wet ?? '—'} | %Moist:${o.moist ?? '—'} | Loc: ${o.loc || '(none)'}`).join('\n')
      : '(No valid tests found. Make sure tests start with "1." / "2." etc.)';
    $('#notesOut').textContent = preview;
    $('#btnReview').disabled = !parsedBlocks.length;
    if (parsedBlocks.length) toast(`Detected ${parsedBlocks.length} test block(s) ✔️`, 'ok'); else toast('No numbered tests detected', 'warn');
  };
  img.onerror = ()=> { $('#notesOut').textContent = 'Could not load image.'; };
  img.src = URL.createObjectURL(file);
}

/* PASTE TEXT */
let pasteModal=null;
function openPasteImport(){ if(!pasteModal) buildPasteModal(); pasteModal.classList.remove('hidden'); $('#pasteArea').focus(); }
function buildPasteModal(){
  pasteModal = document.createElement('div'); pasteModal.className='modal hidden';
  pasteModal.innerHTML = `
    <div class="sheet">
      <header class="inline" style="justify-content:space-between">
        <h2>Paste Text</h2>
        <div class="inline"><button class="btn secondary" id="btnClosePaste" style="width:auto">Close</button></div>
      </header>
      <div class="row" style="grid-template-columns:1fr">
        <textarea id="pasteArea" placeholder="Paste raw text here — one test per line or paragraph.&#10;Example:&#10;1. 148.9 8.9 North lane 50ft E of west end&#10;2) 147.6 8.5 Lane 2 @ 200ft E"></textarea>
        <div class="inline" style="gap:8px">
          <button class="btn primary" id="btnAnalyzePaste">Analyze</button>
          <button class="btn secondary" id="btnReviewPaste" disabled>Review Changes…</button>
        </div>
        <pre id="pasteOut" class="muted" style="white-space:pre-wrap"></pre>
      </div>
    </div>`;
  document.body.appendChild(pasteModal);
  $('#btnClosePaste').addEventListener('click', ()=>pasteModal.classList.add('hidden'));
  $('#btnAnalyzePaste').addEventListener('click', ()=>{
    const text = $('#pasteArea').value || '';
    parsedBlocks = parseNotesBlocks(text);
    const preview = parsedBlocks.length
      ? parsedBlocks.map(o => `#${o.n} | WD:${o.wet ?? '—'} | %Moist:${o.moist ?? '—'} | Loc: ${o.loc || '(none)'}`).join('\n')
      : '(No valid tests found. Make sure tests start with "1." / "2." etc.)';
    $('#pasteOut').textContent = preview;
    $('#btnReviewPaste').disabled = !parsedBlocks.length;
    if (parsedBlocks.length) toast(`Detected ${parsedBlocks.length} test block(s) from pasted text ✔️`, 'ok'); else toast('No numbered tests detected in pasted text', 'warn');
  });
  $('#btnReviewPaste').addEventListener('click', openDiffPreview);
}

/* Robust splitter: find test starts; tolerant to "1.", "1)", "1:", "1 -" */
function parseNotesBlocks(text){
  const s = String(text || '').replace(/\r/g,'');
  const startReG = /(^|\n)\s*(\d{1,3})\s*(?:[.) :-])?\s+(?=\d)/g;
  const starts = [];
  let m;
  while ((m = startReG.exec(s)) !== null){
    const idx = m.index + (m[1] ? m[1].length : 0);
    const n = parseInt(m[2],10);
    starts.push({ idx, n });
  }
  if (!starts.length) return [];
  const blocks = [];
  for (let i = 0; i < starts.length; i++){
    const a = starts[i].idx;
    const b = (i+1 < starts.length) ? starts[i+1].idx : s.length;
    const chunk = s.slice(a, b).trim();
    const parsed = parseOneBlockSlice(chunk, starts[i].n);
    if (parsed) blocks.push(parsed);
  }
  return blocks;
}
function parseOneBlockSlice(slice, testNum){
  const m = slice.match(/^\s*(\d{1,3})\s*(?:[.) :-])?\s+([\s\S]*)$/);
  if (!m) return null;
  var rest = m[2].replace(/\s+/g,' ').trim();

  const numRe = /\b\d{1,3}(?:\.\d)?\b/g;
  const tokens = [];
  let k;
  while ((k = numRe.exec(rest)) !== null){
    tokens.push({ val: parseFloat(k[0]), start: k.index, end: k.index + k[0].length });
  }
  if (tokens.length < 2) return null;

  const isWD    = v => v >= 100 && v <= 250;
  const isMoist = v => v >= 0   && v <= 40;
  const limit = Math.min(8, tokens.length);

  let iHit = -1, jHit = -1, wd = null, moist = null;

  outer:
  for (let i = 0; i < limit; i++){
    for (let j = i+1; j < limit; j++){
      const a = tokens[i].val, b = tokens[j].val;
      if ((isWD(a) && isMoist(b)) || (isMoist(a) && isWD(b))){
        iHit = i; jHit = j;
        wd    = isWD(a) ? a : b;
        moist = isMoist(a) ? a : b;
        break outer;
      }
    }
  }
  if (iHit === -1) return null;

  const after = tokens[jHit].end;
  const loc = rest.slice(after).replace(/^[^\w(]+/, '').trim() || null;

  const t = state.job.targetDensity;
  const pct = (t && t>0) ? Math.round((wd/t*100)*10)/10 : null;

  return { n: testNum, loc, wet: wd, moist, pct };
}

/* ---------- Diff preview + renumber planning ---------- */
let diffModalBuilt=false;
function openDiffPreview(){
  if (!parsedBlocks.length) return;
  if (!diffModalBuilt) buildDiffModal();

  lastPlan = planRenumberAndAssignments(parsedBlocks, state.tests);

  const moved = lastPlan.existingMoves.filter(x => x.from !== x.to);
  const inserted = lastPlan.assignments;

  $('#diffSummary').textContent =
    `Will insert ${inserted.length} test${inserted.length===1?'':'s'}`
    + (moved.length ? ` and renumber ${moved.length} existing.` : '.');

  const insList = $('#diffInserts'); insList.innerHTML='';
  inserted.forEach(a=>{
    const li = document.createElement('li');
    li.textContent = `#${a.desired} → #${a.assigned}  •  WD ${a.block.wet}  •  %Moist ${a.block.moist}  •  ${a.block.loc || '(no location)'}`;
    li.classList.add('diff-ins');
    insList.appendChild(li);
  });

  const mvList = $('#diffMoves'); mvList.innerHTML='';
  if (moved.length){
    moved.sort((a,b)=> a.from - b.from).forEach(m=>{
      const li = document.createElement('li');
      li.textContent = `Test #${m.from} → #${m.to}`;
      li.classList.add('diff-move');
      mvList.appendChild(li);
    });
    $('#movesWrap').classList.remove('hidden');
  } else {
    $('#movesWrap').classList.add('hidden');
  }

  diffModal.classList.remove('hidden');
}
function buildDiffModal(){
  diffModal = document.createElement('div'); diffModal.className='modal hidden';
  diffModal.innerHTML = `
    <div class="sheet">
      <header class="inline" style="justify-content:space-between">
        <h2>Review Changes</h2>
        <div class="inline">
          <button class="btn secondary" id="btnCancelDiff" style="width:auto">Cancel</button>
          <button class="btn primary" id="btnApplyDiff" style="width:auto">Confirm & Apply</button>
        </div>
      </header>
      <div class="banner" id="diffSummary">—</div>
      <div class="divider"></div>
      <h3 style="margin:10px 0 6px">New Tests to Insert</h3>
      <ul id="diffInserts" style="margin:0 0 8px 18px; padding:0"></ul>
      <div id="movesWrap">
        <h3 style="margin:12px 0 6px">Existing Tests to Renumber</h3>
        <ul id="diffMoves" style="margin:0 0 8px 18px; padding:0"></ul>
      </div>
    </div>`;
  document.body.appendChild(diffModal);
  $('#btnCancelDiff').addEventListener('click', ()=> diffModal.classList.add('hidden'));
  $('#btnApplyDiff').addEventListener('click', applyDiffPlan);
  diffModalBuilt=true;
}

function planRenumberAndAssignments(blocks, existingTests){
  const currNums = new Set(existingTests.map(t=>t.n));
  const originals = existingTests.map(t=>t.n).sort((a,b)=>a-b);
  const currMap = new Map(originals.map(n => [n, n])); // original -> current

  const sortedBlocks = [...blocks].sort((a,b)=> a.n - b.n);
  const assignments = []; // {desired, assigned, block}

  for (const b of sortedBlocks){
    let target = b.n;
    while (currNums.has(target)){
      const newSet = new Set();
      for (const n of currNums){ newSet.add(n >= target ? n+1 : n); }
      currNums.clear(); newSet.forEach(x=>currNums.add(x));
      for (const [orig, cur] of currMap.entries()){
        if (cur >= target) currMap.set(orig, cur+1);
      }
      target += 1;
    }
    currNums.add(target);
    assignments.push({ desired: b.n, assigned: target, block: b });
  }

  const existingMoves = Array.from(currMap.entries()).map(([from,to]) => ({from,to}));
  return { assignments, existingMoves };
}

function applyDiffPlan(){
  if (!lastPlan) return;

  const moveMap = new Map(lastPlan.existingMoves.map(m => [m.from, m.to]));
  for (const t of state.tests){
    const to = moveMap.get(t.n);
    if (to != null) t.n = to;
  }

  for (const a of lastPlan.assignments){
    const b = a.block;
    state.tests.push({ n: a.assigned, loc: b.loc, wet: b.wet, moist: b.moist, pct: b.pct, grid: null });
  }

  state.tests.sort((x,y)=> x.n - y.n);

  save();
  diffModal.classList.add('hidden');
  if (importModal) importModal.classList.add('hidden');
  if (pasteModal)  pasteModal.classList.add('hidden');
  testNumber.value = String(state.tests.length + 1);

  const moved = lastPlan.existingMoves.filter(x => x.from !== x.to).length;
  const msg = `Added ${lastPlan.assignments.length} test${lastPlan.assignments.length===1?'':'s'}`
            + (moved ? ` • Renumbered ${moved} existing` : '') + ' ✔️';
  banner('ok', msg); toast(msg, 'ok'); updateProgress();
}

/* ========================= Site Photo + Grid ========================= */
let photoModal = null;
function openPhotoGrid(){ if (!photoModal) buildPhotoModal(); photoModal.classList.remove('hidden'); }
function buildPhotoModal(){
  photoModal = document.createElement('div'); photoModal.className='modal hidden';
  photoModal.innerHTML = `
    <div class="sheet">
      <header class="inline" style="justify-content:space-between">
        <h2>Site Photo + Grid</h2>
        <div class="inline">
          <input type="file" id="photoPick" accept="image/*" class="btn secondary" style="padding:8px 10px; width:auto">
          <button class="btn secondary" id="btnClosePhoto" style="width:auto">Close</button>
        </div>
      </header>

      <div class="row">
        <div class="input-wrap">
          <label for="gridRows">Rows (letters)</label>
          <input id="gridRows" type="number" min="1" max="52" value="${state.photo.rows}">
        </div>
        <div class="input-wrap">
          <label for="gridCols">Cols (numbers)</label>
          <input id="gridCols" type="number" min="1" max="200" value="${state.photo.cols}">
        </div>
      </div>

      <div class="row">
        <div class="input-wrap">
          <label for="gridColor">Line Color</label>
          <input id="gridColor" type="color" value="${state.photo.line}">
        </div>
        <div class="input-wrap">
          <label for="gridAlpha">Line Opacity</label>
          <input id="gridAlpha" type="range" min="0.1" max="1" step="0.05" value="${state.photo.alpha}">
        </div>
      </div>

      <div class="row">
        <div class="input-wrap">
          <label for="gridLW">Line Width</label>
          <input id="gridLW" type="number" min="1" max="10" value="${state.photo.lw}">
        </div>
        <div class="inline">
          <label class="muted"><input type="checkbox" id="gridLabels" ${state.photo.labels ? 'checked' : ''}> Show Labels</label>
        </div>
      </div>

      <div class="scan-grid">
        <div><canvas id="photoCanvasEdit" height="360"></canvas></div>
        <div>
          <div class="help">Upload a site photo, adjust grid settings, then <strong>Save to Summary</strong>. Rows are labeled A, B, C…; columns are 1…N.</div>
          <div class="inline" style="gap:8px; margin-top:8px">
            <button class="btn primary" id="btnSaveGrid">Save to Summary</button>
            <button class="btn secondary" id="btnResetMarkers">Clear Markers</button>
          </div>
          <div id="photoNote" class="muted" style="margin-top:8px"></div>
        </div>
      </div>
    </div>`;
  document.body.appendChild(photoModal);
  $('#btnClosePhoto').addEventListener('click', ()=> photoModal.classList.add('hidden'));
  $('#photoPick').addEventListener('change', onPickSitePhoto);
  $('#gridRows').addEventListener('input', refreshGridPreview);
  $('#gridCols').addEventListener('input', refreshGridPreview);
  $('#gridColor').addEventListener('input', refreshGridPreview);
  $('#gridAlpha').addEventListener('input', refreshGridPreview);
  $('#gridLW').addEventListener('input', refreshGridPreview);
  $('#gridLabels').addEventListener('change', refreshGridPreview);
  $('#btnSaveGrid').addEventListener('click', saveGridToState);
  $('#btnResetMarkers').addEventListener('click', ()=>{ state.photo.markers=[]; renderPhotoWithMarkersToCanvas(); toast('Cleared all markers ✔️','ok'); });
  refreshGridPreview();
}

async function onPickSitePhoto(ev){
  const file = ev.target.files && ev.target.files[0] ? ev.target.files[0] : null; if (!file) return;
  const img = await loadImage(URL.createObjectURL(file));
  state.photo.original = await drawImageToDataURL(img); // normalized
  state.photo.width = img.naturalWidth; state.photo.height = img.naturalHeight;
  toast('Photo loaded ✔️','ok');
  refreshGridPreview();
}

function refreshGridPreview(){
  const c = $('#photoCanvasEdit'); if (!c) return;
  const ctx = c.getContext('2d');
  const p = state.photo;

  // read controls
  p.rows = Math.max(1, Math.min(52, parseInt($('#gridRows').value || p.rows,10)));
  p.cols = Math.max(1, Math.min(200, parseInt($('#gridCols').value || p.cols,10)));
  p.line = $('#gridColor').value || p.line;
  p.alpha = +($('#gridAlpha').value || p.alpha);
  p.lw = Math.max(1, Math.min(10, parseInt($('#gridLW').value || p.lw,10)));
  p.labels = $('#gridLabels').checked;

  // draw preview
  ctx.clearRect(0,0,c.width,c.height);
  if (!p.original){ $('#photoNote').textContent = 'Pick a photo to begin.'; return; }

  const img = new Image(); img.onload = ()=>{
    // fit image into preview canvas (maintain aspect)
    const maxW = 1000; const scale = Math.min(1, maxW / img.width);
    c.width = Math.round(img.width*scale); c.height = Math.round(img.height*scale);
    ctx.clearRect(0,0,c.width,c.height);
    ctx.drawImage(img, 0, 0, c.width, c.height);
    drawGridOnCtx(ctx, c.width, c.height, p);
    $('#photoNote').textContent = `Preview • ${p.rows} rows (A..${rowNumberToLetters(p.rows)}), ${p.cols} cols (1..${p.cols})`;
  };
  img.src = p.original;
}

async function saveGridToState(){
  const p = state.photo;
  if (!p.original) return toast('Pick a photo first.', 'warn');
  // Create a full-resolution composite with grid only
  const base = await loadImage(p.original);
  const c = document.createElement('canvas'); c.width = base.naturalWidth; c.height = base.naturalHeight;
  const ctx = c.getContext('2d'); ctx.drawImage(base, 0, 0);
  drawGridOnCtx(ctx, c.width, c.height, p);
  p.annotatedBase = c.toDataURL('image/png');
  p.width = c.width; p.height = c.height;
  save();
  renderPhotoWithMarkersToCanvas();
  toast('Saved annotated photo ✔️ (markers will show in Summary)', 'ok');
}

function drawGridOnCtx(ctx, w, h, p){
  ctx.save();
  ctx.globalAlpha = p.alpha;
  ctx.strokeStyle = p.line;
  ctx.lineWidth = p.lw;

  const cellW = w / p.cols;
  const cellH = h / p.rows;

  // vertical lines + column labels
  for (let x=0; x<=p.cols; x++){
    const px = Math.round(x*cellW)+0.5;
    ctx.beginPath(); ctx.moveTo(px, 0); ctx.lineTo(px, h); ctx.stroke();
    if (p.labels && x>0 && x<=p.cols){
      ctx.fillStyle = '#0b132a'; ctx.fillRect(px-cellW+2, 2, cellW-4, 24);
      ctx.fillStyle = '#e7ecf5'; ctx.font = '14px ui-monospace,Menlo,monospace'; ctx.textAlign='center'; ctx.textBaseline='top';
      ctx.fillText(String(x), px - cellW/2, 4);
    }
  }
  // horizontal lines + row labels
  for (let y=0; y<=p.rows; y++){
    const py = Math.round(y*cellH)+0.5;
    ctx.beginPath(); ctx.moveTo(0, py); ctx.lineTo(w, py); ctx.stroke();
    if (p.labels && y>0 && y<=p.rows){
      ctx.fillStyle = '#0b132a'; ctx.fillRect(2, py-cellH+2, 24, cellH-4);
      ctx.fillStyle = '#e7ecf5'; ctx.font = '14px ui-monospace,Menlo,monospace'; ctx.textAlign='left'; ctx.textBaseline='middle';
      ctx.fillText(rowNumberToLetters(y), 6, py - cellH/2);
    }
  }
  ctx.restore();
}

function renderPhotoWithMarkersToCanvas() {
  const p = state.photo;
  const wrap = document.getElementById('photoWrap');
  const cv = document.getElementById('photoCanvas');
  if (!wrap || !cv) return;
  if (!p || !p.annotatedBase || !p.width || !p.height) {
    wrap.classList.add('hidden'); return;
  }
  wrap.classList.remove('hidden');

  cv.width = p.width; cv.height = p.height;
  const ctx = cv.getContext('2d');

  const base = new Image();
  base.onload = ()=>{
    ctx.clearRect(0,0,cv.width,cv.height);
    ctx.drawImage(base, 0, 0, cv.width, cv.height);
    drawMarkersOnCtx(ctx, p);
  };
  base.src = p.annotatedBase;
}

function drawMarkersOnCtx(ctx, p){
  const pins = p.markers || [];
  ctx.save();
  ctx.font = Math.max(14, Math.round(p.width * 0.02)) + 'px ui-monospace, Menlo, monospace';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';

  pins.forEach(pin => {
    const x = pin.x, y = pin.y;
    const r = Math.max(8, Math.round(p.width * 0.008));
    ctx.beginPath();
    ctx.arc(x, y, r, 0, Math.PI*2);
    ctx.fillStyle = '#0b132a';
    ctx.fill();
    ctx.lineWidth = Math.max(2, Math.round(p.width * 0.003));
    ctx.strokeStyle = '#22c55e';
    ctx.stroke();

    const label = String(pin.n);
    const padX = 6, padY = 3;
    const metrics = ctx.measureText(label);
    const lw = metrics.width + padX*2;
    const lh = parseInt(ctx.font,10) + padY*2;
    const lx = x; const ly = y - r - lh*0.9;

    ctx.fillStyle = 'rgba(0,0,0,0.6)';
    roundRect(ctx, lx - lw/2, ly - lh/2, lw, lh, 6); ctx.fill();

    ctx.fillStyle = '#e7ecf5';
    ctx.fillText(label, lx, ly);
  });

  ctx.restore();
}

/* ========================= Progress ========================= */
function updateProgress(){
  const n = state.tests.length;
  $('#testsCount').textContent = n;
  const pct = Math.min(100, (n/10)*100); // soft goal: 10 tests
  $('#progFill').style.width = pct + '%';
  $('#resumeBadge').classList.toggle('hidden', n===0);
}
$('#resumeBadge').addEventListener('click', ()=>{
  entryCard.classList.remove('hidden');
  summaryCard.classList.add('hidden');
  toast('Resumed session','ok');
});

/* ========================= Helpers & Toast & Grid Utils ========================= */
function roundRect(ctx, x, y, w, h, r) {
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
}
function rowNumberToLetters(num) {
  let s = '';
  while (num > 0) {
    const rem = (num - 1) % 26;
    s = String.fromCharCode(65 + rem) + s;
    num = Math.floor((num - 1) / 26);
  }
  return s;
}
function coordToRowCol(coord) {
  if (!coord) return null;
  const m = String(coord).trim().match(/^([A-Za-z]{1,2})(\d{1,3})$/);
  if (!m) return null;
  const letters = m[1].toUpperCase(); const colNum = parseInt(m[2], 10);
  let rowNum = 0; for (let i = 0; i < letters.length; i++) { rowNum = rowNum * 26 + (letters.charCodeAt(i) - 64); }
  return { row: rowNum, col: colNum };
}
function isCoordInBounds(row, col, rows, cols) { return row >= 1 && row <= rows && col >= 1 && col <= cols; }
function gridCellCenterPx(row, col, p) {
  if (!p || !p.width || !p.height || !p.rows || !p.cols) return null;
  const cellW = p.width / p.cols; const cellH = p.height / p.rows;
  return { x: (col - 0.5) * cellW, y: (row - 0.5) * cellH };
}
async function loadImage(src){ return await new Promise((res,rej)=>{ const img=new Image(); img.onload=()=>res(img); img.onerror=rej; img.src=src; }); }
async function drawImageToDataURL(img){ const c=document.createElement('canvas'); c.width=img.naturalWidth; c.height=img.naturalHeight; const ctx=c.getContext('2d'); ctx.drawImage(img,0,0); return c.toDataURL('image/png'); }
function slug(s=''){ return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
function download(href, filename){ const a=document.createElement('a'); a.href=href; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); }

let toastTimer=null;
function toast(msg, type='ok'){
  clearTimeout(toastTimer);
  let bar = document.getElementById('toast');
  if (!bar){
    bar = document.createElement('div'); bar.id='toast'; document.body.appendChild(bar);
    Object.assign(bar.style, { position:'fixed', left:'50%', bottom:'22px', transform:'translateX(-50%)',
      padding:'12px 14px', borderRadius:'12px', border:'1px solid #203050', background:'#0b1227',
      color:'#e5e7eb', fontSize:'14px', zIndex:9999, boxShadow:'0 10px 30px #0007', transition:'opacity .2s' });
  }
  const color = type==='ok'? '#22c55e' : type==='warn'? '#f59e0b' : '#ef4444';
  bar.style.borderColor = color + '88';
  bar.innerHTML = `<span style="color:${color}; font-weight:800; margin-right:8px">•</span>${msg}`;
  bar.style.opacity='1';
  toastTimer = setTimeout(()=> bar.style.opacity='0', 2600);
}
</script>
</body>
</html>
